pipeline {
    // Définir l’agent Jenkins sur lequel s'exécute le  CI-CD
    // agent any

    agent {
        label 'agent-windows'
    }



    environment {
        // Définir des variables d’environnement pour l’image Docker
        DOCKERHUB_USER = "encvr1"
        BACKEND_IMAGE  = "${DOCKERHUB_USER}/backend-courrier"
        FRONTEND_IMAGE = "${DOCKERHUB_USER}/frontend-courrier"
        BACKEND_TAG    = "1.${BUILD_NUMBER}"
        FRONTEND_TAG   = "1.${BUILD_NUMBER}"

        // Frontend  private repository
        FRONTEND_REPO_URL     = 'https://github.com/devopsencvr/frontend-courrier-physique.git'
        FRONTEND_REPO_BRANCH  = 'master'
        FRONTEND_CREDENTIALS  = 'credential-id-github'


    }

    stages {

             //  Checkout Backend
             stage('Checkout Backend') {
                 steps {
                     dir('backend') {
                         checkout scm
                     }
                 }
             }

             //  Checkout Frontend
             stage('Checkout Frontend') {
                 steps {
                     dir('frontend') {
                         git branch: env.FRONTEND_REPO_BRANCH,
                             url: env.FRONTEND_REPO_URL,
                             credentialsId: env.FRONTEND_CREDENTIALS
                     }
                 }
             }


             //  Build Backend Docker Image
             stage('Build Backend Docker Image') {
                 steps {
                     dir('backend') {
                         script {
                             bat "docker build -t %BACKEND_IMAGE%:%BACKEND_TAG% ."
                         }
                     }
                 }
             }

             //  Build Frontend Docker Image
             stage('Build Frontend Docker Image') {
                 steps {
                     dir('frontend') {
                         script {
                             // Dockerfile gère npm ci et build Angular
                             bat "docker build -t %FRONTEND_IMAGE%:%FRONTEND_TAG% ."
                         }
                     }
                 }
             }


             stage('Deploy with Docker Compose') {
                 steps {
                     // Déployer les services avec Docker Compose en mode détaché
                     bat "docker-compose down || true"
                     bat "docker-compose up -d --build"
                 }
             }

    }

    post {
        success {
            // Afficher un message si le pipeline réussit
            echo " Déploiement réussi"
        }
        failure {
            // Afficher un message si le pipeline échoue
            echo " Le pipeline a échoué, vérifie les logs Jenkins."
        }



    }
}
